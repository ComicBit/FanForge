esphome:
  name: fanforge-controller
  friendly_name: FanForge Controller
  min_version: 2024.12.0
  includes:
    - fanforge_api.h
  on_boot:
    priority: -100
    then:
      - lambda: |-
          fanforge_api_init();

esp32:
  board: seeed_xiao_esp32c3
  framework:
    type: arduino

logger:

api:
ota:

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  ap:
    ssid: "FanForge Fallback"
    password: !secret fallback_ap_password

captive_portal:

web_server:
  port: 80
  version: 3

# DS18B20 bus
one_wire:
  - platform: gpio
    pin: GPIO3
    id: ow_bus

sensor:
  - platform: dallas_temp
    one_wire_id: ow_bus
    id: temp_c
    name: "Controller Temperature"
    # 9-bit (0.5 C) shortens conversion time to ~94 ms.
    # ESPHome's dallas_temp reads asynchronously (conversion + deferred readback),
    # so this does not block the main control loop.
    resolution: 9
    update_interval: 1s

# 6N137-driven PWM output.
# Intel 4-wire PWM fans usually expect open-collector / active-low style drive.
# This setup uses software inversion in fanforge_api.h (FT_PWM_INVERTED=true).
output:
  - platform: ledc
    id: fan_pwm_output
    pin: GPIO5
    frequency: 25000 Hz

# Persisted UI-matching config
globals:
  - id: cfg_mode
    type: int
    restore_value: yes
    initial_value: '0'   # 0=auto,1=manual,2=off

  - id: cfg_smoothing_mode
    type: int
    restore_value: yes
    initial_value: '1'   # 0=linear,1=smooth

  - id: cfg_points_json
    type: std::string
    restore_value: yes
    initial_value: '"[{\"t\":20,\"p\":20},{\"t\":30,\"p\":30},{\"t\":40,\"p\":55},{\"t\":50,\"p\":100}]"'

  - id: cfg_curve_min
    type: float
    restore_value: yes
    initial_value: '15'

  - id: cfg_curve_max
    type: float
    restore_value: yes
    initial_value: '50'

  - id: cfg_min_pwm
    type: float
    restore_value: yes
    initial_value: '22'

  - id: cfg_max_pwm
    type: float
    restore_value: yes
    initial_value: '100'

  - id: cfg_slew_pct_per_sec
    type: float
    restore_value: yes
    initial_value: '10'

  - id: cfg_failsafe_temp
    type: float
    restore_value: yes
    initial_value: '80'

  - id: cfg_failsafe_pwm
    type: float
    restore_value: yes
    initial_value: '100'

  - id: cfg_manual_pwm
    type: float
    restore_value: yes
    initial_value: '50'

  # Runtime status values exposed in /api/status
  - id: current_pwm_pct
    type: float
    restore_value: no
    initial_value: '0'

  - id: last_update_ms
    type: uint32_t
    restore_value: no
    initial_value: '0'

number:
  - platform: template
    id: fan_manual_pwm
    name: "Fan Manual PWM"
    min_value: 0
    max_value: 100
    step: 1
    unit_of_measurement: "%"
    mode: slider
    lambda: |-
      return id(cfg_manual_pwm);
    set_action:
      - lambda: |-
          id(cfg_manual_pwm) = x;

select:
  - platform: template
    id: fan_mode
    name: "Fan Mode"
    options:
      - "auto"
      - "manual"
      - "off"
    lambda: |-
      if (id(cfg_mode) == 1) return std::string("manual");
      if (id(cfg_mode) == 2) return std::string("off");
      return std::string("auto");
    set_action:
      - lambda: |-
          if (x == "manual") {
            id(cfg_mode) = 1;
          } else if (x == "off") {
            id(cfg_mode) = 2;
          } else {
            id(cfg_mode) = 0;
          }

interval:
  - interval: 200ms
    then:
      - lambda: |-
          fanforge_control_tick();
